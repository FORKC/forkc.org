var tribe=tribe||{};tribe.tickets=tribe.tickets||{},tribe.dialogs=tribe.dialogs||{},tribe.dialogs.events=tribe.dialogs.events||{},tribe.tickets.block={num_attendees:0,event:{}},function(t,e,i){"use strict";e.selector={blockFooter:".tribe-tickets__footer",blockFooterAmount:".tribe-amount",blockFooterQuantity:".tribe-tickets__footer__quantity__number",blockSubmit:".tribe-tickets__submit",container:"#tribe-tickets",hidden:"tribe-common-a11y-hidden",item:".tribe-tickets__item",itemExtraAvailable:".tribe-tickets__item__extra__available",itemExtraAvailableQuantity:".tribe-tickets__item__extra__available__quantity",itemOptOut:".tribe-tickets-attendees-list-optout--wrapper",itemOptOutInput:"#tribe-tickets-attendees-list-optout-",itemPrice:".tribe-amount",itemQuantity:".tribe-tickets__item__quantity",itemQuantityInput:".tribe-tickets-quantity",loader:".tribe-common-c-loader",submit:".tribe-tickets__buy",ticketLoader:".tribe-tickets-loader__tickets-block",validationNotice:".tribe-tickets__notice--error",ticketInCartNotice:"#tribe-tickets__notice__tickets-in-cart"};var r=t(e.selector.container);0!==r.length&&(e.document=t(document),e.modalSelector={cartForm:".tribe-modal__wrapper--ar #tribe-modal__cart",container:".tribe-modal__wrapper--ar",form:"#tribe-tickets__modal-form",itemRemove:".tribe-tickets__item__remove",itemTotal:".tribe-tickets__item__total .tribe-amount",loader:".tribe-tickets-loader__modal",metaField:".ticket-meta",metaForm:".tribe-modal__wrapper--ar #tribe-modal__attendee_registration",metaItem:".tribe-ticket",submit:".tribe-block__tickets__item__attendee__fields__footer_submit"},e.commerceSelector={edd:"Tribe__Tickets_Plus__Commerce__EDD__Main",rsvp:"Tribe__Tickets__RSVP",tpp:"Tribe__Tickets__Commerce__PayPal__Main",Tribe__Tickets__Commerce__PayPal__Main:"tribe-commerce",Tribe__Tickets__RSVP:"rsvp",Tribe__Tickets_Plus__Commerce__EDD__Main:"edd",Tribe__Tickets_Plus__Commerce__WooCommerce__Main:"woo",tribe_eddticket:"Tribe__Tickets_Plus__Commerce__EDD__Main",tribe_tpp_attendees:"Tribe__Tickets__Commerce__PayPal__Main",tribe_wooticket:"Tribe__Tickets_Plus__Commerce__WooCommerce__Main",woo:"Tribe__Tickets_Plus__Commerce__WooCommerce__Main"},e.tribe_ticket_provider=r.data("provider"),e.postId=t(".status-publish").attr("id").replace("post-",""),e.init=function(){0<TribeTicketOptions.availability_check_interval&&e.checkAvailability(),TribeTicketOptions.ajax_preload_ticket_form&&(e.loaderShow(),e.initPrefill())},e.updateAvailability=function(i){Object.keys(i).forEach(function(r){var a=i[r].available,o=t(e.selector.item+"[data-ticket-id='"+r+"']");if(0===a){var c=i[r].unavailable_html;o.attr("available",!1),o.removeClass("instock"),o.removeClass("purchasable"),o.find(e.selector.itemQuantity).html(c),o.find(e.selector.itemExtraAvailable).html("")}1<a&&(o.find(e.selector.itemQuantityInput).attr({max:a}),o.find(e.selector.itemExtraAvailableQuantity).html(a))})},e.updateFooter=function(t){e.updateFooterCount(t),e.updateFooterAmount(t),t.find(".tribe-tickets__footer").addClass("tribe-tickets__footer--active")},e.updateFooterCount=function(i){var r=i.find(e.selector.blockFooter+" "+e.selector.blockFooterQuantity),a=0;if(i.find(e.selector.item+" "+e.selector.itemQuantityInput).each(function(){var e=parseInt(t(this).val(),10);e=isNaN(e)?0:e,a+=e}),i.hasClass("tribe-tickets")){var o=0>=a;t(e.selector.blockSubmit).prop("disabled",o)}0>a||r.text(a)},e.updateFooterAmount=function(i){var r=i.find(e.selector.blockFooter+" "+e.selector.blockFooterAmount),a=0;i.find(e.selector.item+" "+e.selector.itemQuantityInput).each(function(){var i=t(this).closest(e.selector.item).find(e.selector.itemPrice).first(),r=parseInt(t(this).val(),10);r=isNaN(r)?0:r;var o=i.text();o=e.cleanNumber(o),a+=o*r}),0>a||r.text(e.numberFormat(a))},e.updateFormTotals=function(i){i.find(e.selector.item).each(function(){var i=t(this),r=e.getQty(i),a=parseFloat(t(this).find(e.modalSelector.itemTotal).first().text().replace(",",""));"."===e.getCurrencyFormatting().thousands_sep&&(a=parseFloat(t(this).find(e.modalSelector.itemTotal).text().replace(/\./g,"").replace(",","."))),parseInt(r,10),a}),e.updateFooter(i),e.appendARFields(i)},e.updateItem=function(i,r,a){var o={};if(o.id=i,a){o.qty=e.getQty(a),o.price=e.getPrice(r),r.find(e.selector.itemQuantityInput).val(o.qty).trigger("change");var c=e.selector.itemOptOutInput+a.data("ticket-id");o.$optOut=t(c);var n=t(c+"-modal");o.$optOut.length&&o.$optOut.is(":checked")?n.val("1"):n.val("0")}else o.qty=e.getQty(r),o.price=e.getPrice(r);return e.updateTotal(o.qty,o.price,r),o},e.updateTotal=function(t,i,r){var a=(t*i).toFixed(e.getCurrencyFormatting().number_of_decimals);return r.find(e.modalSelector.itemTotal).text(e.numberFormat(a)),a},e.maybeShowNonMetaNotice=function(i){var r=0,a=0,o=i.find(e.selector.item).filter(function(i){return t(this).find(e.selector.itemQuantityInput).val()>0});if(o.length){o.each(function(){var i=t(this),o=i.closest(e.selector.item).data("ticket-id");t(e.modalSelector.metaForm).find('.tribe-tickets__item__attendee__fields__container[data-ticket-id="'+o+'"]').length?a+=e.getQty(i):r+=e.getQty(i)});var c=t(".tribe-tickets__notice--non-ar"),n=t(".tribe-tickets__item__attendee__fields__title");0<r&&0<a?(t("#tribe-tickets__non-ar-count").text(r),c.removeClass("tribe-common-a11y-hidden"),n.show()):(c.addClass("tribe-common-a11y-hidden"),n.hide())}},e.getRestEndpoint=function(){return TribeCartEndpoint.url},e.getTickets=function(){return t(e.selector.item).map(function(){return t(this).data("ticket-id")}).get()},e.maybeShowOptOut=function(t,i){if(t.has(e.selector.itemOptOut).length){var r=t.closest(e.selector.item).find(e.selector.itemOptOut);0<i?r.show():r.hide()}},e.appendARFields=function(i){i.find(e.selector.item).each(function(){var i=t(this);if(i.is(":visible")){var r=i.closest(e.selector.item).data("ticket-id"),a=t(e.modalSelector.metaForm).find('.tribe-tickets__item__attendee__fields__container[data-ticket-id="'+r+'"]');if(!a.length)return;var o=a.find(e.modalSelector.metaItem),c=e.getQty(i);if(0>=c)return a.removeClass("tribe-tickets--has-tickets"),void a.find(e.modalSelector.metaItem).remove();if(o.length>c){var n=o.length-c;a.find(".tribe-ticket:nth-last-child( -n+"+n+" )").remove()}else if(o.length<c){var s=window.wp.template("tribe-registration--"+r),l=0<o.length?o.length+1:1;a.addClass("tribe-tickets--has-tickets");for(var d=l;d<=c;d++){var m={attendee_id:d};a.append(s(m)),e.maybeHydrateAttendeeBlockFromLocal(o.length)}}}}),e.maybeShowNonMetaNotice(i),e.loaderHide(),e.document.trigger("tribe-ar-fields-appended")},e.stepUp=function(t,i){var r=t.attr("max")?Number(t.attr("max")):-1,a=t.attr("step")?Number(t.attr("step")):1,o=-1===r||r>=i+a?i+a:r,c=t.closest(e.selector.item);if("true"===c.attr("data-has-shared-cap")){var n=c.closest("form");o=e.checkSharedCapacity(n,o)}if(0!==o)if(0>o)t[0].value=i+o;else if("function"==typeof t[0].stepUp)try{t[0].stepUp()}catch(e){t.val(o)}else t.val(o)},e.stepDown=function(t,e){var i=t.attr("min")?Number(t.attr("min")):0,r=t.attr("step")?Number(t.attr("step")):1,a=i<=e-r&&0<e-r?e-r:i;if("function"==typeof t[0].stepDown)try{t[0].stepDown()}catch(e){t[0].value=a}else t[0].value=a},e.checkAvailability=function(){var i={action:"ticket_availability_check",tickets:e.getTickets()};t.post(TribeTicketOptions.ajaxurl,i,function(t){if(t.success){var i=t.data.tickets;e.updateAvailability(i)}}),0<TribeTicketOptions.availability_check_interval&&setTimeout(e.checkAvailability,TribeTicketOptions.availability_check_interval)},e.checkSharedCapacity=function(i,r){var a=[],o=[],c=i.find(e.selector.item).filter('[data-has-shared-cap="true"]'),n=c.find(e.selector.itemQuantityInput);if(!c.length)return r;c.each(function(){a.push(parseInt(t(this).attr("data-shared-cap"),10))}),n.each(function(){o.push(parseInt(t(this).val(),10))}),a=Math.max(...a),o=o.reduce(function(t,e){return t+e},0);var s=a-o;return Math.min(s,r)},e.getQty=function(t){var i=parseInt(t.find(e.selector.itemQuantityInput).val(),10);return isNaN(i)?0:i},e.getPrice=function(t){var i=parseFloat(t.find(e.selector.itemPrice).first().text());return isNaN(i)?0:i},e.getCurrencyFormatting=function(){return JSON.parse(TribeCurrency.formatting)[e.tribe_ticket_provider]},e.cleanNumber=function(t){var i=e.getCurrencyFormatting();if(i.thousands_sep===i.decimal_point){var r=t.length-(i.number_of_decimals+1);t=(t=(t=t.substr(0,r)+"_"+t.substr(r+1)).split(i.thousands_sep).join("")).split("_").join(".")}else t=(t=t.split(i.thousands_sep).join("")).split(i.decimal_point).join(".");return t},e.numberFormat=function(t){var i=e.getCurrencyFormatting();if(!i)return!1;var r=i.number_of_decimals,a=i.decimal_point,o=i.thousands_sep,c=isFinite(+t)?+t:0,n=isFinite(+r)?Math.abs(r):0,s=void 0===o?",":o,l=void 0===a?".":a,d=(n?function(t,e){var i=Math.pow(10,e);return Math.round(t*i)/i}(c,n):Math.round(c)).toString().split(l);return d[0].length>3&&(d[0]=d[0].replace(/\B(?=(?:\d{3} )+(?!\d))/g,s)),(d[1]||"").length<n&&(d[1]=d[1]||"",d[1]+=new Array(n-d[1].length+1).join("0")),d.join(l)},e.focusTicketBlock=function(i){t(i).closest(e.modalSelector.metaItem).addClass("tribe-ticket-item__has-focus")},e.unfocusTicketBlock=function(i){t(i).closest(e.modalSelector.metaItem).removeClass("tribe-ticket-item__has-focus")},e.loaderShow=function(i){void 0===i&&(i=e.selector.ticketLoader),t(e.selector.loader).filter(i).removeClass(e.selector.hidden)},e.loaderHide=function(i){void 0===i&&(i=e.selector.ticketLoader),t(e.selector.loader).filter(i).addClass(e.selector.hidden)},e.initPrefill=function(){e.prefillTicketsBlock()},e.initModalFormPrefills=function(){e.loaderShow(e.modalSelector.loader),t.when(e.getData()).then(function(i){if(e.prefillModalCartForm(t(e.modalSelector.cartForm)),i.meta){t.each(i.meta,function(t){r.find(`[data-ticket-id="${t.ticket_id}"]`).length&&e.prefillModalMetaForm(i.meta)})}var a=e.getLocal();a.meta&&e.prefillModalMetaForm(a.meta);window.setTimeout(e.loaderHide,500,e.modalSelector.loader)})},e.prefillModalMetaForm=function(i,r){if(!(void 0===i||0>=i.length)){if(void 0===r)r=0;var a=t(e.modalSelector.metaForm).find(".tribe-tickets__item__attendee__fields__container");if(0<r)i.splice(0,r-1);t.each(i,function(i,r){var o=0,c=a.find(e.modalSelector.metaItem).filter(`[data-ticket-id="${r.ticket_id}"]`);c.length&&t.each(r.items,function(e,i){"object"==typeof i&&(t.each(i,function(e,i){var r=c.eq(o).find(`[name*="${e}"]`);r.is(":radio")||r.is(":checkbox")?r.each(function(e){var r=t(this);i===r.val()&&r.prop("checked",!0)}):r.val(i)}),o++)})}),e.loaderHide(e.modalSelector.loader)}},e.prefillModalCartForm=function(i){i.find(e.selector.item).hide();var a=r.find(e.selector.item);t.each(a,function(e,r){var a=t(r),o=i.find('[data-ticket-id="'+a.attr("data-ticket-id")+'"]');o&&(0<a.find(".tribe-tickets-quantity").val()&&o.fadeIn())}),e.appendARFields(i),e.loaderHide(e.modalSelector.loader)},e.prefillTicketsBlock=function(){t.when(e.getData(!0)).then(function(i){var r=i.tickets;if(r.length){var a=0;r.forEach(function(i){var r=t(`.tribe-tickets__item[data-ticket-id="${i.ticket_id}"]`);if("true"===r.attr("data-available")){var o=r.find(e.selector.itemQuantityInput),c=r.find(e.selector.itemOptOutInput+i.ticket_id);o.length&&(o.val(i.quantity),o.trigger("change"),a+=i.quantity,1==parseInt(i.optout,10)&&c.prop("checked","true"))}}),0<a&&t(e.selector.ticketInCartNotice).fadeIn()}e.loaderHide()},function(){var i=t(e.selector.ticketInCartNotice);i.removeClass("tribe-tickets__notice--barred tribe-tickets__notice--barred-left").addClass("tribe-tickets__notice--error"),i.find(".tribe-tickets-notice__title").text(TribeMessages.api_error_title),i.find(".tribe-tickets-notice__content").text(TribeMessages.connection_error),i.fadeIn(),e.loaderHide()})},e.storeLocal=function(t){var i=e.getMetaForSave();sessionStorage.setItem("tribe_tickets_attendees-"+e.postId,window.JSON.stringify(i));var r=e.getTicketsForCart();sessionStorage.setItem("tribe_tickets_cart-"+e.postId,window.JSON.stringify(r))},e.getLocal=function(t){if(!t)t=e.postId;return{meta:window.JSON.parse(sessionStorage.getItem("tribe_tickets_attendees-"+t)),tickets:window.JSON.parse(sessionStorage.getItem("tribe_tickets_cart-"+t))}},e.clearLocal=function(t){if(!t)t=e.postId;sessionStorage.removeItem("tribe_tickets_attendees-"+t),sessionStorage.removeItem("tribe_tickets_cart-"+t)},e.maybeHydrateAttendeeBlockFromLocal=function(i){t.when(e.getData()).then(function(r){if(r.meta){var a=r.meta.length;if(i<a)e.prefillModalMetaForm(r.meta,i);else{var o=t(e.modalSelector.metaForm).find(e.modalSelector.metaItem).slice(i-1);o&&o.find(e.modalSelector.metaField).each(function(){var e=t(this),i=e.attr("name"),a=r[i];a&&e.val(a)})}}})},e.getTicketsForCart=function(){var i=[],r=t(e.modalSelector.cartForm);return r.length||(r=t(e.selector.container)),r.find(e.selector.item).each(function(){var r=t(this),a=r.data("ticketId"),o=r.find(e.selector.itemQuantityInput).val(),c=r.find('[name="attendee[optout]"]'),n=c.val();c.is(":checkbox")&&(n=c.prop("checked")?1:0);var s={};s.ticket_id=a,s.quantity=o,s.optout=n,i.push(s)}),i},e.getMetaForSave=function(){var i=t(e.modalSelector.metaForm).find(e.modalSelector.metaItem),r=[],a=[];return i.each(function(){var i={},r=t(this),o=r.data("ticketId"),c=r.find(e.modalSelector.metaField);c.length&&(a[o]||(a[o]={},a[o].ticket_id=o,a[o].items=[]),c.each(function(){var e=t(this),r=e.val(),a=e.is(":radio"),o=e.attr("name");if(o=(o=o.split("[")).pop().replace("]",""),(a||e.is(":checkbox"))&&!e.prop("checked")){if(a&&""!==i[o])return;r=""}i[o]=r}),a[o].items.push(i))}),Object.keys(a).forEach(function(t){var e={ticket_id:t,items:a[t].items};r.push(e)}),r},e.getData=function(i){var a={meta:{},tickets:{}},o=t.Deferred(),c=window.JSON.parse(sessionStorage.getItem("tribe_tickets_attendees-"+e.postId));if(null!==c&&(a.meta=c),!i){var n=window.JSON.parse(sessionStorage.getItem("tribe_tickets_cart-"+e.postId));null!==n&&n.length&&(a.tickets=n),o.resolve(a)}return a.tickets&&a.meta||t.ajax({type:"GET",data:{provider:r.data("providerId"),post_id:e.postId},dataType:"json",url:e.getRestEndpoint(),success:function(t){null===c&&sessionStorage.setItem("tribe_tickets_attendees-"+e.postId,window.JSON.stringify(t.meta)),sessionStorage.setItem("tribe_tickets_cart-"+e.postId,window.JSON.stringify(t.tickets));var i={meta:t.meta,tickets:t.tickets};o.resolve(i)},error:function(){o.reject(!1)}}),o.promise()},e.validateForm=function(i){var r=i.find(e.modalSelector.metaItem),a=!0,o=0;return r.each(function(){var i=t(this);e.validateBlock(i)||(o++,a=!1)}),[a,o]},e.validateBlock=function(i){var r=i.find(e.modalSelector.metaField),a=!0;return r.each(function(){var i=t(this);e.validateField(i[0])||(a=!1)}),a?i.removeClass("tribe-ticket-item__has-error"):i.addClass("tribe-ticket-item__has-error"),a},e.validateCheckboxRadioGroup=function(i){var r=i.find(e.modalSelector.metaField),a=!1,o=!0;return r.each(function(){var e=t(this);e.is(":checked")&&(a=!0),e.prop("required")||(o=!1)}),!o||a},e.validateField=function(i){var r=!0,a=t(i);if(!(r=i.checkValidity()))if((a=t(i)).is(":checkbox")||a.is(":radio")){var o=a.closest(".tribe-common-form-control-checkbox-radio-group");o.length&&(r=e.validateCheckboxRadioGroup(o))}else r=!1;return r?a.removeClass("ticket-meta__has-error"):a.addClass("ticket-meta__has-error"),r},e.document.on("click touchend",".tribe-tickets__item__quantity__remove, .tribe-tickets__item__quantity__add",function(i){i.preventDefault();var r=t(this).parent().find('input[type="number"]');if(r.is(":disabled"))return!1;i.preventDefault();var a=Number(r[0].value),o=r.closest(e.modalSelector.cartForm);if(t(this).hasClass("tribe-tickets__item__quantity__add")?e.stepUp(r,a):e.stepDown(r,a),e.updateFooter(r.closest("form")),a!==r[0].value&&r.trigger("change"),o.length){var c=r.closest(e.selector.item);e.updateTotal(e.getQty(c),e.getPrice(c),c)}}),e.document.on("click",e.modalSelector.itemRemove,function(i){i.preventDefault();var r={},a=t(this).closest("form"),o=t(this).closest(e.selector.item);o.find(e.selector.itemQuantity).val(0),o.fadeOut(),r.id=o.data("ticketId"),r.qty=0,o.find(e.selector.itemQuantityInput).val(r.qty),r.price=e.getPrice(o),e.updateTotal(r.qty,r.price,o),e.updateFormTotals(a),t('.tribe-tickets__item__attendee__fields__container[data-ticket-id="'+r.id+'"]').removeClass("tribe-tickets--has-tickets").find(e.modalSelector.metaItem).remove();window.setTimeout(e.maybeShowNonMetaNotice,500,a),window.setTimeout(function(){if(0>=a.find(e.selector.item).filter(":visible").length){var i=t(e.selector.blockSubmit).attr("data-content"),r="dialog_obj_"+i.substring(i.lastIndexOf("-")+1);window[r].hide()}},500)}),e.document.on("focus",".tribe-ticket .ticket-meta",function(t){var i=t.target;e.focusTicketBlock(i)}),e.document.on("blur",".tribe-ticket .ticket-meta",function(t){var i=t.target;e.unfocusTicketBlock(i)}),e.document.on("change keyup",e.selector.itemQuantityInput,function(i){var r=t(this),a=r.closest(e.selector.item),o=(a.data("ticket-id"),r.closest("form")),c=r.attr("max"),n=parseInt(r.val(),10);if(c<(n=isNaN(n)?0:n)&&(n=c,r.val(c)),"true"===a.attr("data-has-shared-cap"))var s=e.checkSharedCapacity(o,n);0>s&&(n+=s,r.val(n)),i.preventDefault(),e.maybeShowOptOut(a,n),e.updateFooter(o),e.updateFormTotals(o)}),e.document.on("beforeunload",function(t){tribe.tickets.modal_redirect?e.clearLocal():e.storeLocal()}),e.document.on("click",e.modalSelector.submit,function(i){i.preventDefault();var r=t(this),a=t(e.modalSelector.form),o=t(e.modalSelector.metaForm),c=e.validateForm(o),n=t(e.selector.validationNotice),s=r.attr("name"),l=a.data("provider");if(e.loaderShow(e.modalSelector.loader),!c[0])return n.find(".tribe-tickets-notice__title").text(TribeMessages.validation_error_title),n.find("p").html(TribeMessages.validation_error),t(e.selector.validationNotice+"__count").text(c[1]),n.show(),e.loaderHide(e.modalSelector.loader),document.getElementById("tribe-tickets__notice__attendee-modal").scrollIntoView({behavior:"smooth",block:"start"}),!1;n.hide(),e.loaderShow(e.modalSelector.loader);var d=TribeTicketsURLs.checkout[l];-1!==s.indexOf("cart")&&(d=TribeTicketsURLs.cart[l]),t(e.modalSelector.form).attr("action",d),console.log(d);var m={tribe_tickets_provider:e.commerceSelector[e.tribe_ticket_provider],tribe_tickets_tickets:e.getTicketsForCart(),tribe_tickets_meta:e.getMetaForSave(),tribe_tickets_post_id:e.postId};t("#tribe_tickets_ar_data").val(JSON.stringify(m)),tribe.tickets.modal_redirect=!0,e.clearLocal(),a.submit()}),e.document.on("click",e.selector.submit,function(i){i.preventDefault();var r=t(this),a=t(e.selector.container);r.attr("name"),a.data("provider");e.loaderShow(e.selector.loader);var o={tribe_tickets_provider:e.commerceSelector[e.tribe_ticket_provider],tribe_tickets_tickets:e.getTicketsForCart(),tribe_tickets_meta:{},tribe_tickets_post_id:e.postId};t("#tribe_tickets_block_ar_data").val(JSON.stringify(o)),a.submit()}),t(i).on("tribe_dialog_show_ar_modal",function(i,a,o){e.loaderShow(),e.loaderShow(e.modalSelector.loader);var c=t(e.modalSelector.cartForm);r.find(e.selector.item).each(function(){var i=t(this),r=i.data("ticketId"),a=c.find('[data-ticket-id="'+r+'"]');a&&e.updateItem(r,a,i)}),e.initModalFormPrefills(),e.updateFormTotals(c),e.loaderHide(),e.loaderHide(e.modalSelector.loader)}),t(i).on("tribe_dialog_close_ar_modal",function(t,i,r){e.storeLocal()}),e.init(),window.addEventListener("pageshow",function(t){(t.persisted||void 0!==window.performance&&2===window.performance.navigation.type)&&e.init()}))}(jQuery,tribe.tickets.block,tribe.dialogs.events);